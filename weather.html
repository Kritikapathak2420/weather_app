<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Weather App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            transition: all 0.5s ease;
            overflow-x: hidden;
        }

        /* Enhanced dynamic backgrounds */
        .clear-day { background: linear-gradient(135deg, #87CEEB, #4682B4); }
        .clear-night { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .cloudy { background: linear-gradient(135deg, #bdc3c7, #95a5a6); }
        .rainy { background: linear-gradient(135deg, #636e72, #2d3436); }
        .snowy { background: linear-gradient(135deg, #ddd6fe, #a5b4fc); }
        .thunderstorm { background: linear-gradient(135deg, #2d3436, #636e72); }

        /* Weather particles */
        .weather-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }

        .rain-particle {
            width: 2px;
            height: 10px;
            border-radius: 1px;
            background: rgba(173, 216, 230, 0.8);
            animation: rain 1s linear infinite;
        }

        .snow-particle {
            width: 4px;
            height: 4px;
            background: white;
            animation: snow 3s linear infinite;
        }

        @keyframes rain {
            to { transform: translateY(100vh); }
        }

        @keyframes snow {
            to { transform: translateY(100vh) rotate(360deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
            to { text-shadow: 2px 2px 20px rgba(255,255,255,0.5); }
        }

        .search-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .search-input {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            width: 300px;
            max-width: 100%;
            outline: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary { background: #00b894; color: white; }
        .btn-secondary { background: #fd79a8; color: white; }
        .btn-warning { background: #fdcb6e; color: white; }
        .btn-info { background: #74b9ff; color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* API Key Setup */
        .api-setup {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            color: white;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .api-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            margin: 10px 0;
            outline: none;
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Favorites bar */
        .favorites-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .favorite-item {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .favorite-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .favorite-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        .glass-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            color: white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }

        /* Weather alerts */
        .weather-alerts {
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        .alert-severe {
            background: rgba(231, 76, 60, 0.9);
            border-left: 5px solid #c0392b;
        }

        .alert-warning {
            background: rgba(241, 196, 15, 0.9);
            border-left: 5px solid #f39c12;
        }

        .alert-info {
            background: rgba(52, 152, 219, 0.9);
            border-left: 5px solid #2980b9;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .current-weather {
            text-align: center;
        }

        .weather-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .temperature {
            font-size: 4rem;
            font-weight: 300;
            margin-bottom: 10px;
            animation: temperatureGlow 3s ease-in-out infinite;
        }

        @keyframes temperatureGlow {
            0%, 100% { text-shadow: 0 0 10px rgba(255,255,255,0.5); }
            50% { text-shadow: 0 0 20px rgba(255,255,255,0.8); }
        }

        .location {
            font-size: 1.5rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .description {
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-transform: capitalize;
            opacity: 0.8;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .detail-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .detail-item:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .detail-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Hourly forecast */
        .hourly-forecast {
            margin-bottom: 30px;
        }

        .hourly-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: thin;
        }

        .hourly-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .hourly-scroll::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .hourly-scroll::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .hourly-item {
            min-width: 100px;
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .hourly-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-5px);
        }

        .hourly-time {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .hourly-icon {
            font-size: 1.5rem;
            margin: 10px 0;
        }

        .hourly-temp {
            font-weight: 600;
        }

        /* Daily forecast */
        .forecast h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .forecast-item {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .forecast-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .forecast-item:hover::before {
            left: 100%;
        }

        .forecast-item:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.2);
        }

        .forecast-day {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .forecast-icon {
            font-size: 2rem;
            margin: 10px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .forecast-temps {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .temp-high {
            font-weight: 600;
        }

        .temp-low {
            opacity: 0.7;
        }

        /* Weather map */
        .weather-map {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .map-layer-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-layer-btn.active {
            background: rgba(255,255,255,0.3);
        }

        /* Weather widgets */
        .weather-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .widget {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .widget:hover {
            transform: scale(1.02);
            background: rgba(255,255,255,0.15);
        }

        .widget-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .widget-value {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .widget-description {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* UV Index colors */
        .uv-low { color: #00e400; }
        .uv-moderate { color: #ffff00; }
        .uv-high { color: #ff7e00; }
        .uv-very-high { color: #ff0000; }
        .uv-extreme { color: #8b00ff; }

        /* Air quality colors */
        .aqi-good { color: #00e400; }
        .aqi-fair { color: #ffff00; }
        .aqi-moderate { color: #ff7e00; }
        .aqi-poor { color: #ff0000; }
        .aqi-very-poor { color: #8b00ff; }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 40px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .success {
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .search-input {
                width: 250px;
            }
            
            .temperature {
                font-size: 3rem;
            }
            
            .weather-details {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .forecast-grid {
                grid-template-columns: 1fr;
            }

            .weather-widgets {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                gap: 5px;
            }

            .nav-tab {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="weather-particles" id="weatherParticles"></div>
    
    <div class="container">
        <!-- API Key Setup -->
        <div id="apiSetup" class="api-setup">
            <h2>🔑 Setup Required</h2>
            <p>Enter your free OpenWeatherMap API key to get started:</p>
            <input type="text" id="apiKeyInput" class="api-input" placeholder="Enter your API key here...">
            <br>
            <button class="btn btn-primary" onclick="saveApiKey()">Save API Key</button>
            <p style="margin-top: 15px; font-size: 0.9rem;">
                Don't have an API key? <a href="https://openweathermap.org/api" target="_blank" style="color: #74b9ff;">Get one free here!</a>
            </p>
        </div>

        <div id="mainApp" class="hidden">
            <div class="header">
                <h1>🌤️ Advanced Weather Hub</h1>
                <div class="search-container">
                    <input type="text" class="search-input" id="cityInput" placeholder="Enter city name (e.g., London, New York)...">
                    <button class="btn btn-primary" onclick="searchWeather()">🔍 Search</button>
                    <button class="btn btn-secondary" onclick="getCurrentLocation()" id="locationBtn">📍 My Location</button>
                    <button class="btn btn-warning" onclick="toggleFavorite()" id="favoriteBtn">⭐ Add Favorite</button>
                </div>
                
                <div class="favorites-bar" id="favoritesBar"></div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('current')">🌡️ Current</button>
                <button class="nav-tab" onclick="showTab('hourly')">⏰ Hourly</button>
                <button class="nav-tab" onclick="showTab('forecast')">📅 5-Day</button>
                <button class="nav-tab" onclick="showTab('map')">🗺️ Map</button>
                <button class="nav-tab" onclick="showTab('widgets')">📊 Widgets</button>
            </div>

            <div id="loading" class="loading hidden">
                Loading weather data...
            </div>

            <div id="error" class="error hidden"></div>
            <div id="success" class="success hidden"></div>

            <div class="weather-alerts" id="weatherAlerts"></div>

            <!-- Current Weather Tab -->
            <div id="currentTab" class="tab-content active">
                <div class="glass-card current-weather" id="currentWeather">
                    <div class="weather-icon" id="weatherIcon">🌤️</div>
                    <div class="temperature" id="temperature">--°</div>
                    <div class="location" id="location">Enter a city name or use your location</div>
                    <div class="description" id="description">Weather information will appear here</div>
                    
                    <div class="weather-details">
                        <div class="detail-item">
                            <div class="detail-label">Feels like</div>
                            <div class="detail-value" id="feelsLike">--°</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Humidity</div>
                            <div class="detail-value" id="humidity">--%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Wind Speed</div>
                            <div class="detail-value" id="windSpeed">-- km/h</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pressure</div>
                            <div class="detail-value" id="pressure">-- hPa</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Visibility</div>
                            <div class="detail-value" id="visibility">-- km</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Sunrise</div>
                            <div class="detail-value" id="sunrise">--:--</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Sunset</div>
                            <div class="detail-value" id="sunset">--:--</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Moon Phase</div>
                            <div class="detail-value" id="moonPhase">🌙</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hourly Forecast Tab -->
            <div id="hourlyTab" class="tab-content">
                <div class="glass-card hourly-forecast">
                    <h2>24-Hour Forecast</h2>
                    <div class="hourly-scroll" id="hourlyForecast">
                        <!-- Hourly items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- 5-Day Forecast Tab -->
            <div id="forecastTab" class="tab-content">
                <div class="glass-card forecast">
                    <h2>5-Day Forecast</h2>
                    <div class="forecast-grid" id="forecastGrid">
                        <!-- Forecast items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Weather Map Tab -->
            <div id="mapTab" class="tab-content">
                <div class="glass-card">
                    <h2>Weather Map</h2>
                    <div class="map-controls">
                        <button class="map-layer-btn active" onclick="changeMapLayer('temp')">🌡️ Temperature</button>
                        <button class="map-layer-btn" onclick="changeMapLayer('precipitation')">🌧️ Precipitation</button>
                        <button class="map-layer-btn" onclick="changeMapLayer('wind')">💨 Wind</button>
                        <button class="map-layer-btn" onclick="changeMapLayer('clouds')">☁️ Clouds</button>
                    </div>
                    <div id="weatherMap" class="weather-map"></div>
                </div>
            </div>

            <!-- Weather Widgets Tab -->
            <div id="widgetsTab" class="tab-content">
                <div class="weather-widgets">
                    <div class="widget glass-card">
                        <div class="widget-title">UV Index</div>
                        <div class="widget-value" id="uvIndex">--</div>
                        <div class="widget-description" id="uvDescription">UV level information</div>
                    </div>
                    
                    <div class="widget glass-card">
                        <div class="widget-title">Air Quality</div>
                        <div class="widget-value" id="airQuality">--</div>
                        <div class="widget-description" id="aqiDescription">Air quality information</div>
                    </div>
                    
                    <div class="widget glass-card">
                        <div class="widget-title">Dew Point</div>
                        <div class="widget-value" id="dewPoint">--°</div>
                        <div class="widget-description">Comfort level indicator</div>
                    </div>
                    
                    <div class="widget glass-card">
                        <div class="widget-title">Cloud Cover</div>
                        <div class="widget-value" id="cloudCover">--%</div>
                        <div class="widget-description">Sky coverage</div>
                    </div>
                    
                    <div class="widget glass-card">
                        <div class="widget-title">Wind Gust</div>
                        <div class="widget-value" id="windGust">-- km/h</div>
                        <div class="widget-description">Maximum wind speed</div>
                    </div>
                    
                    <div class="widget glass-card">
                        <div class="widget-title">Rain Chance</div>
                        <div class="widget-value" id="rainChance">--%</div>
                        <div class="widget-description">Probability of precipitation</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuration
        let API_KEY = localStorage.getItem('weatherApiKey') || '';
        const BASE_URL = 'https://api.openweathermap.org/data/2.5';
        const GEO_URL = 'https://api.openweathermap.org/geo/1.0';

        // Weather icon mapping
        const WEATHER_ICONS = {
            '01d': '☀️', '01n': '🌙',
            '02d': '⛅', '02n': '☁️',
            '03d': '☁️', '03n': '☁️',
            '04d': '☁️', '04n': '☁️',
            '09d': '🌧️', '09n': '🌧️',
            '10d': '🌦️', '10n': '🌧️',
            '11d': '⛈️', '11n': '⛈️',
            '13d': '❄️', '13n': '❄️',
            '50d': '🌫️', '50n': '🌫️'
        };

        // Moon phases
        const MOON_PHASES = ['🌑', '🌒', '🌓', '🌔', '🌕', '🌖', '🌗', '🌘'];

        // Global variables
        let currentLocationData = null;
        let weatherMap = null;
        let currentMapLayer = 'temp';
        let favorites = JSON.parse(localStorage.getItem('weatherFavorites')) || [];

        // Initialize app
        window.addEventListener('load', function() {
            if (API_KEY) {
                showMainApp();
                loadFavorites();
                // Try to get user's location on load
                showSuccess('Welcome! Try searching for a city or use your location.');
            } else {
                showApiSetup();
            }
        });

        // API Key Management
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                API_KEY = apiKey;
                localStorage.setItem('weatherApiKey', apiKey);
                showMainApp();
                showSuccess('API key saved! You can now use the weather app.');
                loadFavorites();
            } else {
                showError('Please enter a valid API key.');
            }
        }

        function showApiSetup() {
            document.getElementById('apiSetup').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('apiSetup').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        // UI Management
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('success').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('success').classList.add('hidden');
            hideLoading();
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 5000);
        }

        // Weather particles
        function createWeatherParticles(weatherType) {
            const particlesContainer = document.getElementById('weatherParticles');
            particlesContainer.innerHTML = '';
            
            if (weatherType === 'rain' || weatherType === 'drizzle') {
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle rain-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 1 + 's';
                    particle.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                    particlesContainer.appendChild(particle);
                }
            } else if (weatherType === 'snow') {
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle snow-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 3 + 's';
                    particle.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    particlesContainer.appendChild(particle);
                }
            }
        }

        // Get weather by coordinates
        async function getWeatherByCoords(lat, lon) {
            try {
                showLoading();
                
                if (!API_KEY) {
                    showError('API key is required. Please set up your API key first.');
                    return;
                }

                console.log(`Fetching weather for coordinates: ${lat}, ${lon}`);

                const [currentResponse, forecastResponse] = await Promise.all([
                    fetch(`${BASE_URL}/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`),
                    fetch(`${BASE_URL}/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`)
                ]);

                console.log('Current weather response:', currentResponse.status);
                console.log('Forecast response:', forecastResponse.status);

                if (!currentResponse.ok) {
                    const errorData = await currentResponse.json();
                    throw new Error(errorData.message || `HTTP ${currentResponse.status}: Weather data not available`);
                }

                if (!forecastResponse.ok) {
                    const errorData = await forecastResponse.json();
                    throw new Error(errorData.message || `HTTP ${forecastResponse.status}: Forecast data not available`);
                }

                const currentData = await currentResponse.json();
                const forecastData = await forecastResponse.json();

                console.log('Weather data received:', currentData.name);

                currentLocationData = { 
                    lat: currentData.coord.lat, 
                    lon: currentData.coord.lon, 
                    name: currentData.name, 
                    country: currentData.sys.country 
                };
                
                displayWeather(currentData, forecastData);
                displayHourlyForecast(forecastData);
                displayForecast(forecastData);
                displayWeatherWidgets(currentData);
                updateBackground(currentData.weather[0].main, currentData.weather[0].icon);
                createWeatherParticles(currentData.weather[0].main.toLowerCase());
                
                updateFavoriteButton();
                hideLoading();
                showSuccess(`Weather loaded for ${currentData.name}, ${currentData.sys.country}`);

            } catch (error) {
                console.error('Weather API Error:', error);
                showError(`Failed to fetch weather data: ${error.message}`);
            }
        }

        // Get weather by city name
        async function getWeatherByCity(city) {
            try {
                showLoading();
                
                if (!API_KEY) {
                    showError('API key is required. Please set up your API key first.');
                    return;
                }

                console.log(`Searching for city: ${city}`);

                // Use direct weather API call with city name
                const [currentResponse, forecastResponse] = await Promise.all([
                    fetch(`${BASE_URL}/weather?q=${encodeURIComponent(city)}&appid=${API_KEY}&units=metric`),
                    fetch(`${BASE_URL}/forecast?q=${encodeURIComponent(city)}&appid=${API_KEY}&units=metric`)
                ]);

                console.log('Current weather response:', currentResponse.status);
                console.log('Forecast response:', forecastResponse.status);

                if (!currentResponse.ok) {
                    const errorData = await currentResponse.json();
                    if (currentResponse.status === 404) {
                        throw new Error(`City "${city}" not found. Please check the spelling and try again.`);
                    }
                    throw new Error(errorData.message || `HTTP ${currentResponse.status}: Unable to fetch weather data`);
                }

                if (!forecastResponse.ok) {
                    const errorData = await forecastResponse.json();
                    throw new Error(errorData.message || `HTTP ${forecastResponse.status}: Unable to fetch forecast data`);
                }

                const currentData = await currentResponse.json();
                const forecastData = await forecastResponse.json();

                console.log('Weather data received for:', currentData.name);

                currentLocationData = { 
                    lat: currentData.coord.lat, 
                    lon: currentData.coord.lon, 
                    name: currentData.name, 
                    country: currentData.sys.country 
                };
                
                displayWeather(currentData, forecastData);
                displayHourlyForecast(forecastData);
                displayForecast(forecastData);
                displayWeatherWidgets(currentData);
                updateBackground(currentData.weather[0].main, currentData.weather[0].icon);
                createWeatherParticles(currentData.weather[0].main.toLowerCase());
                
                updateFavoriteButton();
                hideLoading();
                showSuccess(`Weather loaded for ${currentData.name}, ${currentData.sys.country}`);

            } catch (error) {
                console.error('City search error:', error);
                showError(error.message);
            }
        }

        // Get current location with enhanced error handling
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by this browser. Please search for a city instead.');
                return;
            }

            showLoading();
            
            const locationBtn = document.getElementById('locationBtn');
            locationBtn.disabled = true;
            locationBtn.textContent = '📍 Getting Location...';

            const options = {
                enableHighAccuracy: true,
                timeout: 15000, // 15 seconds
                maximumAge: 300000 // 5 minutes
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('Location obtained:', position.coords.latitude, position.coords.longitude);
                    const { latitude, longitude } = position.coords;
                    getWeatherByCoords(latitude, longitude);
                    
                    locationBtn.disabled = false;
                    locationBtn.textContent = '📍 My Location';
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    let errorMessage = 'Unable to get your location. ';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Location access denied. Please enable location services in your browser settings and try again.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information unavailable. Please try searching for a city instead.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out. Please try again or search for a city.';
                            break;
                        default:
                            errorMessage += 'An unknown error occurred. Please try searching for a city instead.';
                            break;
                    }
                    
                    showError(errorMessage);
                    
                    locationBtn.disabled = false;
                    locationBtn.textContent = '📍 My Location';
                },
                options
            );
        }

        // Search weather by city
        function searchWeather() {
            const city = document.getElementById('cityInput').value.trim();
            if (city) {
                getWeatherByCity(city);
                document.getElementById('cityInput').value = '';
            } else {
                showError('Please enter a city name.');
            }
        }

        // Display current weather
        function displayWeather(current, forecast) {
            const weatherIcon = WEATHER_ICONS[current.weather[0].icon] || '🌤️';
            
            document.getElementById('weatherIcon').textContent = weatherIcon;
            document.getElementById('temperature').textContent = `${Math.round(current.main.temp)}°C`;
            document.getElementById('location').textContent = `${current.name}, ${current.sys.country}`;
            document.getElementById('description').textContent = current.weather[0].description;
            document.getElementById('feelsLike').textContent = `${Math.round(current.main.feels_like)}°C`;
            document.getElementById('humidity').textContent = `${current.main.humidity}%`;
            document.getElementById('windSpeed').textContent = `${Math.round(current.wind.speed * 3.6)} km/h`;
            document.getElementById('pressure').textContent = `${current.main.pressure} hPa`;
            document.getElementById('visibility').textContent = current.visibility ? `${(current.visibility / 1000).toFixed(1)} km` : 'N/A';
            
            // Sunrise and sunset
            if (current.sys.sunrise && current.sys.sunset) {
                const sunrise = new Date(current.sys.sunrise * 1000);
                const sunset = new Date(current.sys.sunset * 1000);
                document.getElementById('sunrise').textContent = sunrise.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.getElementById('sunset').textContent = sunset.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            // Moon phase (simplified calculation)
            const moonPhase = getMoonPhase(new Date());
            document.getElementById('moonPhase').textContent = MOON_PHASES[moonPhase];
        }

        // Display hourly forecast
        function displayHourlyForecast(forecast) {
            const hourlyContainer = document.getElementById('hourlyForecast');
            hourlyContainer.innerHTML = '';

            // Get next 24 hours (8 items, 3-hour intervals)
            const hourlyData = forecast.list.slice(0, 8);

            hourlyData.forEach(hour => {
                const date = new Date(hour.dt * 1000);
                const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const weatherIcon = WEATHER_ICONS[hour.weather[0].icon] || '🌤️';

                const hourlyItem = document.createElement('div');
                hourlyItem.className = 'hourly-item';
                hourlyItem.innerHTML = `
                    <div class="hourly-time">${time}</div>
                    <div class="hourly-icon">${weatherIcon}</div>
                    <div class="hourly-temp">${Math.round(hour.main.temp)}°</div>
                    <div class="hourly-desc">${hour.weather[0].main}</div>
                `;
                hourlyContainer.appendChild(hourlyItem);
            });
        }

        // Display 5-day forecast
        function displayForecast(forecast) {
            const forecastGrid = document.getElementById('forecastGrid');
            forecastGrid.innerHTML = '';

            // Get one forecast per day (every 8th item, as API returns 3-hour intervals)
            const dailyForecasts = forecast.list.filter((item, index) => index % 8 === 0).slice(0, 5);

            dailyForecasts.forEach(day => {
                const date = new Date(day.dt * 1000);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const weatherIcon = WEATHER_ICONS[day.weather[0].icon] || '🌤️';

                const forecastItem = document.createElement('div');
                forecastItem.className = 'forecast-item';
                forecastItem.innerHTML = `
                    <div class="forecast-day">${dayName}</div>
                    <div class="forecast-icon">${weatherIcon}</div>
                    <div class="description">${day.weather[0].description}</div>
                    <div class="forecast-temps">
                        <span class="temp-high">${Math.round(day.main.temp_max)}°</span>
                        <span class="temp-low">${Math.round(day.main.temp_min)}°</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.8rem;">
                        <div>💧 ${day.main.humidity}%</div>
                        <div>💨 ${Math.round(day.wind.speed * 3.6)} km/h</div>
                    </div>
                `;
                forecastGrid.appendChild(forecastItem);
            });
        }

        // Display weather widgets
        function displayWeatherWidgets(current) {
            // UV Index (simulated)
            const uvIndex = Math.floor(Math.random() * 12);
            document.getElementById('uvIndex').textContent = uvIndex;
            
            let uvClass = 'uv-low';
            let uvDesc = 'Low';
            if (uvIndex >= 11) { uvClass = 'uv-extreme'; uvDesc = 'Extreme'; }
            else if (uvIndex >= 8) { uvClass = 'uv-very-high'; uvDesc = 'Very High'; }
            else if (uvIndex >= 6) { uvClass = 'uv-high'; uvDesc = 'High'; }
            else if (uvIndex >= 3) { uvClass = 'uv-moderate'; uvDesc = 'Moderate'; }
            
            document.getElementById('uvIndex').className = `widget-value ${uvClass}`;
            document.getElementById('uvDescription').textContent = uvDesc;

            // Air Quality (simulated)
            const aqi = Math.floor(Math.random() * 5) + 1;
            const aqiLabels = ['Good', 'Fair', 'Moderate', 'Poor', 'Very Poor'];
            const aqiClasses = ['aqi-good', 'aqi-fair', 'aqi-moderate', 'aqi-poor', 'aqi-very-poor'];
            
            document.getElementById('airQuality').textContent = aqi;
            document.getElementById('airQuality').className = `widget-value ${aqiClasses[aqi-1]}`;
            document.getElementById('aqiDescription').textContent = aqiLabels[aqi-1];

            // Dew Point
            const dewPoint = current.main.temp - ((100 - current.main.humidity) / 5);
            document.getElementById('dewPoint').textContent = `${Math.round(dewPoint)}°C`;

            // Cloud Cover
            document.getElementById('cloudCover').textContent = `${current.clouds.all}%`;

            // Wind Gust
            const windGust = current.wind.gust ? Math.round(current.wind.gust * 3.6) : Math.round(current.wind.speed * 3.6 * 1.5);
            document.getElementById('windGust').textContent = `${windGust} km/h`;

            // Rain Chance (simplified)
            const rainChance = Math.round(Math.random() * 100);
            document.getElementById('rainChance').textContent = `${rainChance}%`;
        }

        // Update background based on weather
        function updateBackground(weatherMain, weatherIcon) {
            const body = document.body;
            const isNight = weatherIcon.includes('n');
            
            // Remove existing weather classes
            body.className = '';
            
            switch (weatherMain.toLowerCase()) {
                case 'clear':
                    body.classList.add(isNight ? 'clear-night' : 'clear-day');
                    break;
                case 'clouds':
                    body.classList.add('cloudy');
                    break;
                case 'rain':
                case 'drizzle':
                    body.classList.add('rainy');
                    break;
                case 'snow':
                    body.classList.add('snowy');
                    break;
                case 'thunderstorm':
                    body.classList.add('thunderstorm');
                    break;
                default:
                    body.classList.add('clear-day');
            }
        }

        // Get moon phase (simplified calculation)
        function getMoonPhase(date) {
            const year = date.getFullYear();
            let month = date.getMonth() + 1;
            const day = date.getDate();
            
            let c = 0;
            let e = 0;
            let jd = 0;
            let b = 0;
            
            if (month < 3) {
                year--;
                month += 12;
            }
            
            ++month;
            c = 365.25 * year;
            e = 30.6 * month;
            jd = c + e + day - 694039.09;
            jd /= 29.5305882;
            b = parseInt(jd);
            jd -= b;
            b = Math.round(jd * 8);
            
            if (b >= 8) b = 0;
            
            return b;
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Initialize map if map tab is selected
            if (tabName === 'map' && currentLocationData) {
                initializeMap();
            }
        }

        // Initialize weather map
        function initializeMap() {
            if (!currentLocationData) return;
            
            const mapContainer = document.getElementById('weatherMap');
            
            if (weatherMap) {
                weatherMap.remove();
            }
            
            weatherMap = L.map('weatherMap').setView([currentLocationData.lat, currentLocationData.lon], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(weatherMap);
            
            // Add weather layer
            changeMapLayer(currentMapLayer);
            
            // Add marker for current location
            L.marker([currentLocationData.lat, currentLocationData.lon])
                .addTo(weatherMap)
                .bindPopup(`${currentLocationData.name}, ${currentLocationData.country}`)
                .openPopup();
        }

        // Change map layer
        function changeMapLayer(layer) {
            if (!weatherMap) return;
            
            // Remove active class from all buttons
            document.querySelectorAll('.map-layer-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            currentMapLayer = layer;
            
            // Remove existing weather layers
            weatherMap.eachLayer(function(mapLayer) {
                if (mapLayer instanceof L.TileLayer && mapLayer.options.attribution && mapLayer.options.attribution.includes('OpenWeatherMap')) {
                    weatherMap.removeLayer(mapLayer);
                }
            });
            
            // Add new weather layer
            let layerUrl = '';
            switch (layer) {
                case 'temp':
                    layerUrl = `https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${API_KEY}`;
                    break;
                case 'precipitation':
                    layerUrl = `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEY}`;
                    break;
                case 'wind':
                    layerUrl = `https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=${API_KEY}`;
                    break;
                case 'clouds':
                    layerUrl = `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEY}`;
                    break;
            }
            
            if (layerUrl && API_KEY) {
                L.tileLayer(layerUrl, {
                    attribution: '© OpenWeatherMap',
                    opacity: 0.6
                }).addTo(weatherMap);
            }
        }

        // Favorites management
        function loadFavorites() {
            const favoritesBar = document.getElementById('favoritesBar');
            favoritesBar.innerHTML = '';
            
            favorites.forEach(favorite => {
                const favoriteItem = document.createElement('div');
                favoriteItem.className = 'favorite-item';
                favoriteItem.innerHTML = `
                    ${favorite.name}
                    <button class="favorite-remove" onclick="removeFavorite('${favorite.name}')">&times;</button>
                `;
                favoriteItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('favorite-remove')) {
                        getWeatherByCity(favorite.name);
                    }
                });
                favoritesBar.appendChild(favoriteItem);
            });
        }

        function toggleFavorite() {
            if (!currentLocationData) {
                showError('Please load weather data first.');
                return;
            }
            
            const locationName = currentLocationData.name;
            const existingIndex = favorites.findIndex(fav => fav.name === locationName);
            
            if (existingIndex > -1) {
                favorites.splice(existingIndex, 1);
                document.getElementById('favoriteBtn').textContent = '⭐ Add Favorite';
                showSuccess(`Removed ${locationName} from favorites.`);
            } else {
                favorites.push({
                    name: locationName,
                    lat: currentLocationData.lat,
                    lon: currentLocationData.lon
                });
                document.getElementById('favoriteBtn').textContent = '⭐ Remove Favorite';
                showSuccess(`Added ${locationName} to favorites.`);
            }
            
            localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
            loadFavorites();
        }

        function removeFavorite(name) {
            favorites = favorites.filter(fav => fav.name !== name);
            localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
            loadFavorites();
            updateFavoriteButton();
            showSuccess(`Removed ${name} from favorites.`);
        }

        function updateFavoriteButton() {
            if (!currentLocationData) return;
            
            const isFavorite = favorites.some(fav => fav.name === currentLocationData.name);
            document.getElementById('favoriteBtn').textContent = isFavorite ? '⭐ Remove Favorite' : '⭐ Add Favorite';
        }

        // Enter key support for search
        document.getElementById('cityInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchWeather();
            }
        });

        // API key input enter key support
        document.getElementById('apiKeyInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveApiKey();
            }
        });
    </script>
</body>
</html>